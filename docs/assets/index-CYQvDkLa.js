(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))u(n);new MutationObserver(n=>{for(const m of n)if(m.type==="childList")for(const g of m.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&u(g)}).observe(document,{childList:!0,subtree:!0});function d(n){const m={};return n.integrity&&(m.integrity=n.integrity),n.referrerPolicy&&(m.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?m.credentials="include":n.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function u(n){if(n.ep)return;n.ep=!0;const m=d(n);fetch(n.href,m)}})();function Q(a,o="en",d=37,u=42,n=7,m=2){var E,x,C;const g=e=>!!e.trim().charAt(0).match(new RegExp("\\p{General_Category=Open_Punctuation}","u")),y=e=>!!e.trim().charAt(e.trim().length-1).match(new RegExp("\\p{General_Category=Final_Punctuation}","u")),f=e=>!!e.trim().charAt(e.trim().length-1).match(/[.!?]|\.\.\./),t=structuredClone(a);t.forEach((e,s,i)=>{const r=e.text;e.length=r.length,e.offset=i.slice(0,s).reduce((w,B)=>w+B.text.length+1,0);const p=r.trim();e.metadata.mpunct=p.length>0&&!!p.charAt(p.length-1).match(/[\p{Pc}\p{Pd}\p{Po}]/u),e.metadata.epunct=f(r)||y(r),e.metadata.spunct=g(r),(e.metadata.epunct||e.metadata.spunct)&&delete e.metadata.mpunct,(e.metadata.epunct||e.metadata.spunct||(e.metadata.mpunct??!1))&&(e.metadata.punct=!0)}),[...new Intl.Segmenter(o,{granularity:"sentence"}).segment(a.map(e=>e.text).join(" "))[Symbol.iterator]()].map(({index:e,segment:s})=>({index:e,length:s.length,text:s})).forEach(e=>{const s=t.find(r=>r.offset===e.index);s&&(s.metadata.sos=!0);const i=t.find(r=>(r.offset??0)+(r.length??0)===e.index+e.length);i&&(i.metadata.eos=!0)}),t.forEach((e,s)=>{s>0&&(e.metadata.sos??!1)&&(t[s-1].metadata.eos=!0)}),t.forEach(e=>{e.metadata.chars=(e.offset??0)+(e.length??0)});let l=0,b=-1,S=0;for(;l<t.length;){if(l===b){if(S++,S>=5){console.error(`Potential infinite loop detected at token: ${((E=t[l])==null?void 0:E.text)||l}`);break}}else S=0,b=l;if(l===0){l++;continue}const e=t[l],s=t[l-1],i=t==null?void 0:t[l-2];e.metadata.chars&&e.metadata.chars>d&&(((e.metadata.eos??!1)||(e.metadata.punct??!1))&&e.metadata.chars<=u?(e.metadata.break=!0,l<t.length-1&&t.slice(l+1).forEach(r=>{r.metadata.chars=(r.metadata.chars??0)-(e.metadata.chars??0)-1})):(((x=i==null?void 0:i.metadata)==null?void 0:x.punct)??!1)||(((C=i==null?void 0:i.metadata)==null?void 0:C.eos)??!1)?(i.metadata.break=!0,l<t.length-1&&t.slice(l-1).forEach(r=>{r.metadata.chars=(r.metadata.chars??0)-(i.metadata.chars??0)-1}),l--):(s.metadata.break=!0,t.slice(l).forEach(r=>{r.metadata.chars=(r.metadata.chars??0)-(s.metadata.chars??0)-1}))),l++}t.forEach((e,s)=>{if(e.metadata.break??!1){const i=t.slice(0,s).reverse().findIndex(p=>p.metadata.break);let r=t.slice(s-i,s);i===-1&&(r=t.slice(0,s)),e.metadata.lineDuration=r.reduce((p,w)=>p+w.duration,0)}});let c=0;t.forEach((e,s)=>{var i;if(e.metadata.break??!1){c++;const r=t.slice(0,s).reverse().find(U=>U.metadata.break),p=t.findIndex(U=>U===r),w=(r==null?void 0:r.start)??0+((r==null?void 0:r.duration)??0),h=(((i=t[p+1])==null?void 0:i.start)??0)-w,T=r&&c%2===1&&((r.metadata.lineDuration??0)+(e.metadata.lineDuration??0)>n||h>m);(c%2===0||(T??!1))&&(e.metadata.subtitleBreak=!0,(T??!1)&&(c=0))}});const v=t[t.length-1];return v.metadata.break=!0,v.metadata.subtitleBreak=!0,t}function Y(a,o=!1,d=20,u=5/6){const n=["WEBVTT","","Kind: captions","Language: en-US","",""];let m=1;return a.forEach((g,y)=>{var S;const f=[];let t=[];const L=a[y+1],q=((S=L==null?void 0:L[0])==null?void 0:S.start)??Number.MAX_SAFE_INTEGER;g.forEach(c=>{t.push(c),(c.metadata.break??!1)&&(f.push(t),t=[])}),console.log({lines:f});const l=[];let b=[];f.forEach(c=>{b.push(c),c.some(v=>v.metadata.subtitleBreak??!1)&&(l.push(b),b=[])}),console.log({cues:l}),l.forEach((c,v)=>{var w,B;const E=c.flat(),x=c.length,C=E[0].start,e=E[E.length-1].start+E[E.length-1].duration;let s=e,i=Math.min(e+7,q);if(v<l.length-1){const h=l[v+1].flat();console.log({nextCue:h,nextStart:(w=h[0])==null?void 0:w.start,cue:c}),i=Math.min(((B=h[0])==null?void 0:B.start)??q,i)}const p=E.reduce((h,T)=>h+T.text.length,0)/d;if(s-C<p||s-C<x*u){const h=s-C<p?p-(s-C):x*u;h>0&&s+h<i?(s+=h,console.log({delta:h,end:s,minEnd:e,maxEnd:i,minDuration:p,cue:c})):h>0&&(console.log({end:s,maxEnd:i,cue:c}),s=i)}n.push(`${m++}
${_(C)} --> ${_(s)} line:85%`),c.forEach(h=>{n.push(h.map(T=>o?`<${_(T.start)}><ruby>${T.text}</ruby>`:T.text).join(" "))}),n.push("")})}),n.join(`
`)}const _=a=>a?new Date(parseFloat(a.toFixed(3))*1e3).toISOString().substring(11,23):"00:00:00:000";let R=[],H=37,V=42,G=7,K=2,W=!1,X=20,z=.83,$="",M="";async function Z(){try{const a=await window.fetch("./sample.json"),{metadata:{src:o},segments:d}=await a.json();$=o,R=d[0].blocks.map(({metadata:{speaker:n},tokens:m})=>m.map(({text:g,start:y,end:f})=>{const t=f-y;return{text:g,start:y,duration:t,metadata:{speaker:n}}}))}catch(a){console.error("Error loading data:",a)}}function J(){const a=R.map(d=>Q(d,"en",H,V,G,K));console.log(a),M=Y(a,W,X,z),console.log(M);const o=document.querySelector("#paragraphs");o.innerHTML="",a.forEach(d=>{const u=document.createElement("div");u.classList.add("paragraphBlock");const n=document.createElement("p");u.appendChild(n);const m=d[0],g=m.start,y=m.metadata.speaker;y!==void 0&&y!==""&&n.setAttribute("data-speaker",y),g!==void 0&&n.setAttribute("data-start",g.toString()),d.forEach(f=>{var S;const t=document.createElement("span");t.style.display="inline-block";const L=document.createElement("ruby"),q=document.createTextNode(f.text),l=document.createElement("rt"),b=[];for(const c in f.metadata)Object.prototype.hasOwnProperty.call(f.metadata,c)&&(f.metadata[c]??!1)&&(c==="chars"||c==="lineDuration"?b.push(((S=f.metadata[c])==null?void 0:S.toString())??""):(b.push(c),t.classList.add(c)));if(l.textContent=b.join(", "),L.appendChild(q),L.appendChild(l),t.appendChild(L),t.setAttribute("title",b.join(", ")),t.setAttribute("data-start",f.start.toString()),n.appendChild(t),t.addEventListener("click",({target:c})=>{var x;const v=(x=c.closest("span"))==null?void 0:x.getAttribute("data-start"),E=document.querySelector("#video video");E&&v!=null&&(E.currentTime=parseFloat(v))}),f.metadata.break??!1){if(n.appendChild(document.createElement("br")),f.metadata.subtitleBreak??!1){const c=document.createElement("hr");c.className="subtitle-break",n.appendChild(c)}}else n.appendChild(document.createTextNode(" "))}),n.classList.add("paragraph"),o.appendChild(u)})}function ee(){const a=document.querySelector("#video");a.innerHTML="";const o=document.createElement("video");o.src=$,o.controls=!0;const d=URL.createObjectURL(new Blob([M],{type:"text/vtt"})),u=document.createElement("track");u.src=d,u.default=!0,u.kind="subtitles",u.srclang="en",u.label="Subtitles",o.appendChild(u),a.appendChild(o);const n=new window.Hls;n.loadSource($),n.attachMedia(o)}function te(){const a=document.querySelector("#video video");if(a){for(;a.firstChild;)a.removeChild(a.firstChild);const o=URL.createObjectURL(new Blob([M],{type:"text/vtt"})),d=document.createElement("track");d.src=o,d.default=!0,d.kind="subtitles",d.srclang="en",d.label="Subtitles",a.appendChild(d)}}async function ae(){await Z(),J(),ee();const a=document.querySelector("#video video");if(a)for(let o=0;o<a.textTracks.length;o++)a.textTracks[o].mode="showing"}function k(){J(),te();const a=document.querySelector("#video video");if(a)for(let o=0;o<a.textTracks.length;o++)a.textTracks[o].mode="showing"}ae();const O=document.querySelector("#show-annotations");O==null||O.addEventListener("change",()=>{const a=document.querySelector("#paragraphs");a==null||a.classList.toggle("show-annotations",O.checked)});const A=document.querySelector("#min-chars");A==null||A.addEventListener("change",()=>{H=parseInt(A.value),k()});const j=document.querySelector("#max-chars");j==null||j.addEventListener("change",()=>{V=parseInt(j.value),k()});const I=document.querySelector("#max-duration");I==null||I.addEventListener("change",()=>{G=parseInt(I.value),k()});const P=document.querySelector("#max-gap");P==null||P.addEventListener("change",()=>{K=parseInt(P.value),k()});const N=document.querySelector("#karaoke");N==null||N.addEventListener("change",()=>{W=N.checked,k()});const D=document.querySelector("#min-reading-speed");D==null||D.addEventListener("change",()=>{X=parseInt(D.value),k()});const F=document.querySelector("#min-line-duration");F==null||F.addEventListener("change",()=>{z=parseFloat(F.value),k()});
