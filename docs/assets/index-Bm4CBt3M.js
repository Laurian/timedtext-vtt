(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))m(r);new MutationObserver(r=>{for(const u of r)if(u.type==="childList")for(const h of u.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&m(h)}).observe(document,{childList:!0,subtree:!0});function d(r){const u={};return r.integrity&&(u.integrity=r.integrity),r.referrerPolicy&&(u.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?u.credentials="include":r.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function m(r){if(r.ep)return;r.ep=!0;const u=d(r);fetch(r.href,u)}})();function J(a,s="en",d=37,m=42,r=7,u=2){var y,p,C;const h=e=>!!e.trim().charAt(0).match(new RegExp("\\p{General_Category=Open_Punctuation}","u")),b=e=>!!e.trim().charAt(e.trim().length-1).match(new RegExp("\\p{General_Category=Final_Punctuation}","u")),f=e=>!!e.trim().charAt(e.trim().length-1).match(/[.!?]|\.\.\./),t=structuredClone(a);t.forEach((e,l,c)=>{const n=e.text;e.length=n.length,e.offset=c.slice(0,l).reduce((L,q)=>L+q.text.length+1,0);const v=n.trim();e.metadata.mpunct=v.length>0&&!!v.charAt(v.length-1).match(/[\p{Pc}\p{Pd}\p{Po}]/u),e.metadata.epunct=f(n)||b(n),e.metadata.spunct=h(n),(e.metadata.epunct||e.metadata.spunct)&&delete e.metadata.mpunct,(e.metadata.epunct||e.metadata.spunct||(e.metadata.mpunct??!1))&&(e.metadata.punct=!0)}),[...new Intl.Segmenter(s,{granularity:"sentence"}).segment(a.map(e=>e.text).join(" "))[Symbol.iterator]()].map(({index:e,segment:l})=>({index:e,length:l.length,text:l})).forEach(e=>{const l=t.find(n=>n.offset===e.index);l&&(l.metadata.sos=!0);const c=t.find(n=>(n.offset??0)+(n.length??0)===e.index+e.length);c&&(c.metadata.eos=!0)}),t.forEach((e,l)=>{l>0&&(e.metadata.sos??!1)&&(t[l-1].metadata.eos=!0)}),t.forEach(e=>{e.metadata.chars=(e.offset??0)+(e.length??0)});let i=0,E=-1,S=0;for(;i<t.length;){if(i===E){if(S++,S>=5){console.error(`Potential infinite loop detected at token: ${((y=t[i])==null?void 0:y.text)||i}`);break}}else S=0,E=i;if(i===0){i++;continue}const e=t[i],l=t[i-1],c=t==null?void 0:t[i-2];e.metadata.chars&&e.metadata.chars>d&&(((e.metadata.eos??!1)||(e.metadata.punct??!1))&&e.metadata.chars<=m?(e.metadata.break=!0,i<t.length-1&&t.slice(i+1).forEach(n=>{n.metadata.chars=(n.metadata.chars??0)-(e.metadata.chars??0)-1})):(((p=c==null?void 0:c.metadata)==null?void 0:p.punct)??!1)||(((C=c==null?void 0:c.metadata)==null?void 0:C.eos)??!1)?(c.metadata.break=!0,i<t.length-1&&t.slice(i-1).forEach(n=>{n.metadata.chars=(n.metadata.chars??0)-(c.metadata.chars??0)-1}),i--):(l.metadata.break=!0,t.slice(i).forEach(n=>{n.metadata.chars=(n.metadata.chars??0)-(l.metadata.chars??0)-1}))),i++}t.forEach((e,l)=>{if(e.metadata.break??!1){const c=t.slice(0,l).reverse().findIndex(v=>v.metadata.break);let n=t.slice(l-c,l);c===-1&&(n=t.slice(0,l)),e.metadata.lineDuration=n.reduce((v,L)=>v+L.duration,0)}});let o=0;if(t.forEach((e,l)=>{var c;if(e.metadata.break??!1){o++;const n=t.slice(0,l).reverse().find(M=>M.metadata.break),v=t.findIndex(M=>M===n),L=(n==null?void 0:n.start)??0+((n==null?void 0:n.duration)??0),g=(((c=t[v+1])==null?void 0:c.start)??0)-L,w=n&&o%2===1&&((n.metadata.lineDuration??0)+(e.metadata.lineDuration??0)>r||g>u);(o%2===0||(w??!1))&&(e.metadata.subtitleBreak=!0,(w??!1)&&(o=0))}}),t.length>0){const e=t[t.length-1];e.metadata.break=!0,e.metadata.subtitleBreak=!0}return t}function Q(a,s=!1,d=20,m=5/6){const r=["WEBVTT","","Kind: captions","Language: en-US","",""];let u=1;return a.forEach((h,b)=>{var S;const f=[];let t=[];const x=a[b+1],k=((S=x==null?void 0:x[0])==null?void 0:S.start)??Number.MAX_SAFE_INTEGER;h.forEach(o=>{t.push(o),(o.metadata.break??!1)&&(f.push(t),t=[])});const i=[];let E=[];f.forEach(o=>{E.push(o),o.some(y=>y.metadata.subtitleBreak??!1)&&(i.push(E),E=[])}),i.forEach((o,y)=>{var q;const p=o.flat(),C=o.length,e=p[0].start,l=p[p.length-1].start+p[p.length-1].duration;let c=l,n=Math.min(l+7,k);if(y<i.length-1){const g=i[y+1].flat();n=Math.min(((q=g[0])==null?void 0:q.start)??k,n)}const L=p.reduce((g,w)=>g+w.text.length,0)/d;if(c-e<L||c-e<C*m){const g=c-e<L?L-(c-e):C*m;g>0&&c+g<n?c+=g:g>0&&(c=n)}r.push(`${u++}
${U(e)} --> ${U(c)} line:85%`),o.forEach(g=>{r.push(g.map(w=>s?`<${U(w.start)}><ruby>${w.text}</ruby>`:w.text).join(" "))}),r.push("")})}),r.join(`
`)}const U=a=>a?new Date(parseFloat(a.toFixed(3))*1e3).toISOString().substring(11,23):"00:00:00:000";let $=[],R=37,H=42,V=7,G=2,K=!1,W=20,X=.83,_="",F="";async function Y(){try{const a=await window.fetch("./sample.json"),{metadata:{src:s},segments:d}=await a.json();_=s,$=d[0].blocks.map(({metadata:{speaker:r},tokens:u})=>u.map(({text:h,start:b,end:f})=>{const t=f-b;return{text:h,start:b,duration:t,metadata:{speaker:r}}}))}catch(a){console.error("Error loading data:",a)}}function z(){const a=$.map(d=>J(d,"en",R,H,V,G));console.log(a),F=Q(a,K,W,X),console.log(F);const s=document.querySelector("#paragraphs");s.innerHTML="",a.forEach(d=>{const m=document.createElement("div");m.classList.add("paragraphBlock");const r=document.createElement("p");m.appendChild(r);const u=d[0],h=u.start,b=u.metadata.speaker;b!==void 0&&b!==""&&r.setAttribute("data-speaker",b),h!==void 0&&r.setAttribute("data-start",h.toString()),d.forEach(f=>{var S;const t=document.createElement("span");t.style.display="inline-block";const x=document.createElement("ruby"),k=document.createTextNode(f.text),i=document.createElement("rt"),E=[];for(const o in f.metadata)Object.prototype.hasOwnProperty.call(f.metadata,o)&&(f.metadata[o]??!1)&&(o==="chars"||o==="lineDuration"?E.push(((S=f.metadata[o])==null?void 0:S.toString())??""):(E.push(o),t.classList.add(o)));if(i.textContent=E.join(", "),x.appendChild(k),x.appendChild(i),t.appendChild(x),t.setAttribute("title",E.join(", ")),t.setAttribute("data-start",f.start.toString()),r.appendChild(t),t.addEventListener("click",({target:o})=>{var C;const y=(C=o.closest("span"))==null?void 0:C.getAttribute("data-start"),p=document.querySelector("#video video");p&&y!=null&&(p.currentTime=parseFloat(y))}),f.metadata.break??!1){if(r.appendChild(document.createElement("br")),f.metadata.subtitleBreak??!1){const o=document.createElement("hr");o.className="subtitle-break",r.appendChild(o)}}else r.appendChild(document.createTextNode(" "))}),r.classList.add("paragraph"),s.appendChild(m)})}function Z(){const a=document.querySelector("#video");a.innerHTML="";const s=document.createElement("video");s.src=_,s.controls=!0;const d=URL.createObjectURL(new Blob([F],{type:"text/vtt"})),m=document.createElement("track");m.src=d,m.default=!0,m.kind="subtitles",m.srclang="en",m.label="Subtitles",s.appendChild(m),a.appendChild(s);const r=new window.Hls;r.loadSource(_),r.attachMedia(s)}function ee(){const a=document.querySelector("#video video");if(a){for(;a.firstChild;)a.removeChild(a.firstChild);const s=URL.createObjectURL(new Blob([F],{type:"text/vtt"})),d=document.createElement("track");d.src=s,d.default=!0,d.kind="subtitles",d.srclang="en",d.label="Subtitles",a.appendChild(d)}}async function te(){await Y(),z(),Z();const a=document.querySelector("#video video");if(a)for(let s=0;s<a.textTracks.length;s++)a.textTracks[s].mode="showing"}function T(){z(),ee();const a=document.querySelector("#video video");if(a)for(let s=0;s<a.textTracks.length;s++)a.textTracks[s].mode="showing"}te();const B=document.querySelector("#show-annotations");B==null||B.addEventListener("change",()=>{const a=document.querySelector("#paragraphs");a==null||a.classList.toggle("show-annotations",B.checked)});const O=document.querySelector("#min-chars");O==null||O.addEventListener("change",()=>{R=parseInt(O.value),T()});const A=document.querySelector("#max-chars");A==null||A.addEventListener("change",()=>{H=parseInt(A.value),T()});const j=document.querySelector("#max-duration");j==null||j.addEventListener("change",()=>{V=parseInt(j.value),T()});const I=document.querySelector("#max-gap");I==null||I.addEventListener("change",()=>{G=parseInt(I.value),T()});const P=document.querySelector("#karaoke");P==null||P.addEventListener("change",()=>{K=P.checked,T()});const N=document.querySelector("#min-reading-speed");N==null||N.addEventListener("change",()=>{W=parseInt(N.value),T()});const D=document.querySelector("#min-line-duration");D==null||D.addEventListener("change",()=>{X=parseFloat(D.value),T()});
